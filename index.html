import React, { useState, useEffect, useRef } from 'react';
import { 
  ArrowLeft, 
  Camera, 
  Check, 
  RotateCcw, 
  Download, 
  Smile, 
  Smartphone,
  Image as ImageIcon,
  RefreshCw,
  Play,
  Type,
  ChevronRight
} from 'lucide-react';

// --- Configuration & Assets ---
const ASSETS = {
  marketing: "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?auto=format&fit=crop&q=80&w=1000",
  stickers: [
    "https://cdn-icons-png.flaticon.com/512/1023/1023656.png",
    "https://cdn-icons-png.flaticon.com/512/3214/3214750.png",
    "https://cdn-icons-png.flaticon.com/512/1023/1023661.png",
    "https://cdn-icons-png.flaticon.com/512/1023/1023666.png",
    "https://cdn-icons-png.flaticon.com/512/744/744922.png",
  ]
};

const LAYOUT_CONFIGS = {
  bandelette: {
    name: "Bandelette Rétro",
    photoCount: 3,
    canvasWidth: 400,
    canvasHeight: 1200,
    description: "Format strip classique 5x15cm"
  },
  polaroid: {
    name: "Format Polaroid",
    photoCount: 1,
    canvasWidth: 800,
    canvasHeight: 1000,
    description: "Carré vintage avec bordure large"
  },
  planche: {
    name: "Planche Événement",
    photoCount: 4,
    canvasWidth: 800,
    canvasHeight: 1200,
    description: "Grille 2x2 pour un maximum de souvenirs"
  }
};

export default function App() {
  const [currentStep, setCurrentStep] = useState('landing');
  const [layout, setLayout] = useState('bandelette'); 
  const [photos, setPhotos] = useState([]);
  const [capturingIndex, setCapturingIndex] = useState(null);
  const [isSequenceRunning, setIsSequenceRunning] = useState(false);
  const [countdown, setCountdown] = useState(null);
  const [flash, setFlash] = useState(false);
  const [customText, setCustomText] = useState("SOUVENIR PHOTO");
  const [history, setHistory] = useState(['landing']);

  const videoRef = useRef(null);
  const fabricCanvas = useRef(null);

  // --- Navigation ---
  const navigateTo = (step) => {
    setHistory(prev => [...prev, currentStep]);
    setCurrentStep(step);
  };

  const goBack = () => {
    if (history.length > 0) {
      const prev = history[history.length - 1];
      setHistory(prev => prev.slice(0, -1));
      setCurrentStep(prev);
    }
  };

  // --- Webcam Control ---
  const startWebcam = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } 
      });
      if (videoRef.current) videoRef.current.srcObject = stream;
    } catch (err) {
      console.error("Caméra inaccessible:", err);
    }
  };

  const stopWebcam = () => {
    if (videoRef.current && videoRef.current.srcObject) {
      videoRef.current.srcObject.getTracks().forEach(track => track.stop());
    }
  };

  // --- Capture Logic ---
  const startFullSequence = async () => {
    setIsSequenceRunning(true);
    const count = LAYOUT_CONFIGS[layout].photoCount;
    const newPhotos = Array(count).fill(null);
    setPhotos(newPhotos);

    for (let i = 0; i < count; i++) {
      await performCapture(i);
      if (i < count - 1) await new Promise(r => setTimeout(r, 1500));
    }
    setIsSequenceRunning(false);
    navigateTo('review');
  };

  const performCapture = (index) => {
    return new Promise((resolve) => {
      setCapturingIndex(index);
      let count = 3;
      setCountdown(count);

      const timer = setInterval(() => {
        count--;
        if (count > 0) {
          setCountdown(count);
        } else {
          clearInterval(timer);
          setCountdown(0);
          setFlash(true);
          setTimeout(() => setFlash(false), 150);
          
          const video = videoRef.current;
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
          ctx.drawImage(video, 0, 0);
          
          const dataUrl = canvas.toDataURL('image/jpeg');
          setPhotos(prev => {
            const next = [...prev];
            next[index] = dataUrl;
            return next;
          });

          setTimeout(() => {
            setCountdown(null);
            setCapturingIndex(null);
            resolve();
          }, 800);
        }
      }, 1000);
    });
  };

  const startSingleRetake = async (index) => {
    navigateTo('capture');
    await startWebcam();
    await performCapture(index);
    navigateTo('review');
  };

  // --- Editor (Fabric.js) ---
  useEffect(() => {
    if (currentStep === 'edit' && !fabricCanvas.current) {
      const script = document.createElement('script');
      script.src = "https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js";
      script.onload = initEditor;
      document.head.appendChild(script);
    }
  }, [currentStep]);

  const initEditor = () => {
    const config = LAYOUT_CONFIGS[layout];
    const canvas = new fabric.Canvas('photobooth-canvas', {
      width: config.canvasWidth,
      height: config.canvasHeight,
      backgroundColor: '#ffffff'
    });
    fabricCanvas.current = canvas;
    renderFinalCanvas();
  };

  const renderFinalCanvas = async () => {
    const canvas = fabricCanvas.current;
    if (!canvas) return;
    canvas.clear();

    const config = LAYOUT_CONFIGS[layout];
    
    for (let i = 0; i < config.photoCount; i++) {
      if (!photos[i]) continue;
      await new Promise(r => {
        fabric.Image.fromURL(photos[i], (img) => {
          let x, y, w;
          if (layout === 'bandelette') {
            w = config.canvasWidth - 40;
            x = 20;
            y = 20 + i * (w * 0.75 + 20);
          } else if (layout === 'polaroid') {
            w = config.canvasWidth - 80;
            x = 40;
            y = 40;
          } else if (layout === 'planche') {
            w = (config.canvasWidth / 2) - 30;
            x = i % 2 === 0 ? 20 : config.canvasWidth / 2 + 10;
            y = i < 2 ? 20 : config.canvasHeight / 2 - 100;
          }
          
          img.set({ left: x, top: y, selectable: false });
          img.scaleToWidth(w);
          canvas.add(img);
          r();
        });
      });
    }

    const text = new fabric.Text(customText.toUpperCase(), {
      left: config.canvasWidth / 2,
      top: config.canvasHeight - 60,
      fontSize: 24,
      fontFamily: 'Helvetica, Arial, sans-serif',
      fontWeight: 'bold',
      originX: 'center',
      fill: '#333333',
      selectable: false
    });
    canvas.add(text);
  };

  const addSticker = (url) => {
    fabric.Image.fromURL(url, (img) => {
      img.scaleToWidth(120);
      img.set({ left: 50, top: 50, cornerColor: '#000000', transparentCorners: false });
      fabricCanvas.current.add(img).setActiveObject(img);
    }, { crossOrigin: 'anonymous' });
  };

  // --- UI Components ---
  const Header = () => (
    <div className="absolute top-0 left-0 right-0 h-20 flex items-center justify-between px-6 z-[60]">
      {currentStep !== 'landing' && !isSequenceRunning && (
        <button onClick={goBack} className="p-3 bg-white text-black rounded-full shadow-xl active:scale-90 transition hover:bg-neutral-100">
          <ArrowLeft size={20} strokeWidth={3} />
        </button>
      )}
      <div className="flex-1 flex justify-center">
          <span className="text-white font-black tracking-[0.3em] text-[10px] sm:text-xs uppercase opacity-80">Licowa Photobooth</span>
      </div>
    </div>
  );

  return (
    <div className="relative w-full h-screen bg-neutral-900 flex items-center justify-center overflow-hidden font-sans">
      
      {/* Background Decor for Desktop */}
      <div className="absolute inset-0 z-0 bg-radial-gradient from-neutral-800 to-neutral-950 opacity-50" />
      
      {/* Main Container (Responsive Chassis) */}
      <div className="relative z-10 w-full h-full sm:max-w-md sm:h-[90vh] sm:rounded-[3rem] sm:border-[12px] sm:border-neutral-800 bg-neutral-950 overflow-hidden shadow-[0_50px_100px_rgba(0,0,0,0.8)]">
        
        <Header />
        {flash && <div className="absolute inset-0 bg-white z-[100] animate-pulse" />}

        {/* 1. LANDING */}
        {currentStep === 'landing' && (
          <div className="flex flex-col items-center justify-between h-full py-16 px-8 text-center animate-in fade-in duration-700">
            <div className="space-y-4 pt-10">
               <h1 className="text-4xl sm:text-5xl font-black tracking-tighter leading-none italic uppercase">
                  Studio<br/><span className="text-neutral-500">Privé</span>
               </h1>
               <p className="text-neutral-400 tracking-widest text-[10px] font-bold uppercase">
                  L'art du portrait instantané
               </p>
            </div>

            <div className="relative w-full max-w-[260px] aspect-[4/5] shadow-2xl">
              <img src={ASSETS.marketing} className="w-full h-full object-cover rounded-sm grayscale-[0.2]" alt="Marketing" />
              <div className="absolute inset-0 border-[1px] border-white/20 m-3 pointer-events-none" />
            </div>

            <button 
              onClick={() => navigateTo('layout')}
              className="group relative w-full py-6 bg-white text-black rounded-full font-black text-xs tracking-[0.3em] uppercase active:scale-95 transition-all overflow-hidden"
            >
              <span className="relative z-10 flex items-center justify-center gap-2">
                  Commencer <ChevronRight size={16} />
              </span>
            </button>
          </div>
        )}

        {/* 2. LAYOUT SELECTION */}
        {currentStep === 'layout' && (
          <div className="flex flex-col items-center justify-center h-full p-8 pt-20 animate-in slide-in-from-bottom-4 duration-500">
            <h2 className="text-[10px] font-black mb-10 uppercase tracking-[0.4em] text-neutral-500">Choix du format</h2>
            <div className="grid grid-cols-1 gap-4 w-full">
              {Object.entries(LAYOUT_CONFIGS).map(([key, cfg]) => (
                <button 
                  key={key}
                  onClick={() => { setLayout(key); navigateTo('capture'); startWebcam(); }} 
                  className="group flex items-center gap-6 p-5 bg-neutral-900/40 hover:bg-neutral-800 rounded-2xl border border-white/5 transition text-left active:scale-98"
                >
                  <div className="w-10 h-14 bg-white/5 rounded-sm flex items-center justify-center group-hover:bg-white/10 transition">
                    {key === 'bandelette' && <div className="w-3 h-8 border border-white/40 flex flex-col gap-0.5 p-0.5"><div className="flex-1 bg-white/20"/><div className="flex-1 bg-white/20"/><div className="flex-1 bg-white/20"/></div>}
                    {key === 'polaroid' && <div className="w-6 h-6 border border-white/40 p-1"><div className="w-full h-2/3 bg-white/20"/></div>}
                    {key === 'planche' && <div className="w-7 h-7 border border-white/40 grid grid-cols-2 gap-0.5 p-0.5"><div className="bg-white/20"/><div className="bg-white/20"/><div className="bg-white/20"/><div className="bg-white/20"/></div>}
                  </div>
                  <div>
                    <span className="block font-black text-xs uppercase tracking-widest">{cfg.name}</span>
                    <span className="text-neutral-600 text-[9px] font-bold uppercase tracking-wider">{cfg.description}</span>
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* 3. CAPTURE */}
        {currentStep === 'capture' && (
          <div className="relative h-full w-full bg-black">
            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover scale-x-[-1]" />
            
            {countdown !== null && (
              <div className="absolute inset-0 flex items-center justify-center z-50">
                <span className="text-[15rem] font-black text-white italic drop-shadow-2xl select-none">
                  {countdown === 0 ? "!" : countdown}
                </span>
              </div>
            )}

            <div className="absolute inset-x-0 bottom-0 p-8 flex flex-col items-center gap-6 bg-gradient-to-t from-black via-black/40 to-transparent">
              <div className="flex justify-center gap-2">
                {photos.map((p, i) => (
                  <div key={i} className={`w-8 h-12 rounded-sm border-2 overflow-hidden transition-all duration-500 ${capturingIndex === i ? 'border-white scale-125 shadow-2xl z-10' : 'border-white/10 opacity-30'}`}>
                    {p ? <img src={p} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-white/5" />}
                  </div>
                ))}
              </div>

              {!isSequenceRunning ? (
                <button 
                  onClick={startFullSequence}
                  className="group w-20 h-20 rounded-full border-[2px] border-white/20 flex items-center justify-center active:scale-90 transition p-1"
                >
                  <div className="w-full h-full bg-white rounded-full flex items-center justify-center group-hover:bg-neutral-200">
                     <Play size={24} className="text-black ml-1" fill="black" />
                  </div>
                </button>
              ) : (
                <div className="h-20 flex items-center">
                  <p className="font-black text-[9px] tracking-[0.8em] text-white/40 animate-pulse uppercase italic">Ne bougez pas</p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* 4. REVIEW */}
        {currentStep === 'review' && (
          <div className="flex flex-col h-full bg-neutral-950 animate-in fade-in duration-500">
            <div className="flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto pt-16">
              <h2 className="text-[9px] font-black mb-6 uppercase tracking-[0.4em] text-neutral-600 italic">Aperçu du tirage</h2>
              
              <div className={`bg-white p-4 shadow-2xl overflow-hidden flex flex-col items-center transition-all duration-700 ${layout === 'bandelette' ? 'w-40 aspect-[1/3.2]' : 'w-64 aspect-[4/5.2]'}`}>
                 <div className={`w-full grid gap-2 ${layout === 'planche' ? 'grid-cols-2' : 'grid-cols-1'}`}>
                    {photos.map((p, i) => (
                      <div key={i} className="relative group bg-neutral-100 aspect-[4/3] overflow-hidden">
                        <img src={p} className="w-full h-full object-cover" />
                        <button 
                          onClick={() => startSingleRetake(i)}
                          className="absolute inset-0 bg-black/90 flex flex-col items-center justify-center opacity-0 hover:opacity-100 transition-opacity"
                        >
                          <RefreshCw size={18} className="mb-1 text-white" />
                          <span className="text-[7px] font-black text-white uppercase tracking-widest text-center leading-tight">Changer<br/>la photo</span>
                        </button>
                      </div>
                    ))}
                 </div>
                 <div className="mt-auto py-4 text-black/20 font-black text-[8px] tracking-[0.4em] uppercase text-center">
                    {customText}
                 </div>
              </div>
            </div>
            
            <div className="p-8 bg-neutral-900/50 border-t border-white/5 flex flex-col gap-3">
               <button 
                onClick={() => { stopWebcam(); navigateTo('edit'); }}
                className="w-full py-5 bg-white text-black font-black text-[10px] active:scale-95 transition tracking-[0.3em] uppercase flex items-center justify-center gap-2 rounded-full"
              >
                Personnaliser <ChevronRight size={14} />
              </button>
            </div>
          </div>
        )}

        {/* 5. EDIT */}
        {currentStep === 'edit' && (
          <div className="flex flex-col h-full bg-neutral-950">
            <div className="flex-1 flex items-center justify-center p-4 overflow-hidden pt-16">
              <div className="max-h-full max-w-full flex items-center justify-center">
                <div className="transform scale-[0.35] sm:scale-[0.55] origin-center shadow-2xl">
                  <canvas id="photobooth-canvas" className="rounded-sm" />
                </div>
              </div>
            </div>
            
            <div className="bg-neutral-900 p-6 flex flex-col gap-5 rounded-t-[2rem] shadow-2xl border-t border-white/5">
              <div className="space-y-1.5">
                <label className="text-[8px] font-black uppercase tracking-widest text-neutral-600 flex items-center gap-2">
                  <Type size={10} /> Signature
                </label>
                <input 
                  type="text" 
                  maxLength={18}
                  value={customText}
                  onChange={(e) => { setCustomText(e.target.value); renderFinalCanvas(); }}
                  className="w-full bg-black/50 border border-white/10 p-3 rounded-xl text-[10px] font-black tracking-widest uppercase focus:border-white transition outline-none"
                />
              </div>

              <div className="space-y-1.5">
                <label className="text-[8px] font-black uppercase tracking-widest text-neutral-600 flex items-center gap-2">
                  <Smile size={10} /> Accessoires
                </label>
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                  {ASSETS.stickers.map((s, idx) => (
                    <button key={idx} onClick={() => addSticker(s)} className="flex-shrink-0 w-11 h-11 bg-black/40 hover:bg-black/60 border border-white/5 rounded-xl p-2.5 active:scale-90 transition">
                      <img src={s} className="w-full h-full object-contain" />
                    </button>
                  ))}
                </div>
              </div>

              <button onClick={() => navigateTo('final')} className="w-full py-4 bg-white text-black font-black active:scale-95 transition uppercase tracking-[0.2em] text-[10px] rounded-full shadow-lg">
                Terminer la création
              </button>
            </div>
          </div>
        )}

        {/* 6. FINAL */}
        {currentStep === 'final' && (
          <div className="flex flex-col items-center justify-center h-full p-10 text-center bg-white text-black animate-in fade-in duration-1000">
            <div className="w-16 h-16 bg-black text-white rounded-full flex items-center justify-center mb-8 shadow-xl">
              <Check size={28} strokeWidth={4} />
            </div>
            <h2 className="text-4xl font-black mb-3 tracking-tighter italic uppercase leading-none">C'est<br/>terminé.</h2>
            <p className="text-neutral-400 mb-12 font-black uppercase tracking-[0.3em] text-[9px]">Votre souvenir est prêt</p>
            
            <div className="w-full space-y-3">
              <button onClick={() => {
                const link = document.createElement('a');
                link.download = 'licowa-photobooth.png';
                link.href = fabricCanvas.current.toDataURL({ quality: 1 });
                link.click();
              }} className="w-full py-5 bg-black text-white font-black flex items-center justify-center gap-3 active:scale-95 transition tracking-widest text-[10px] rounded-full">
                <Download size={18} /> Télécharger le tirage
              </button>
              
              <button 
                onClick={() => {
                  const original = fabricCanvas.current;
                  const wall = document.createElement('canvas');
                  wall.width = 1080; wall.height = 2340;
                  const ctx = wall.getContext('2d');
                  ctx.fillStyle = '#0a0a0a';
                  ctx.fillRect(0,0,1080,2340);
                  const img = new Image();
                  img.onload = () => {
                    const s = 1.6;
                    const x = (1080 - original.width * s) / 2;
                    const y = (2340 - original.height * s) / 2;
                    ctx.drawImage(img, x, y, original.width * s, original.height * s);
                    const link = document.createElement('a');
                    link.download = 'wallpaper.png';
                    link.href = wall.toDataURL();
                    link.click();
                  };
                  img.src = original.toDataURL();
                }}
                className="w-full py-5 bg-neutral-100 text-black font-black flex items-center justify-center gap-3 active:scale-95 transition border border-black/5 tracking-widest text-[10px] rounded-full"
              >
                <Smartphone size={18} /> Format Smartphone
              </button>
            </div>
            
            <button 
              onClick={() => { setPhotos([]); setCurrentStep('layout'); }}
              className="mt-12 text-neutral-400 font-black uppercase text-[8px] tracking-[0.5em] flex items-center gap-2 hover:text-black transition"
            >
              <RotateCcw size={12} /> Nouvelle Séance
            </button>
          </div>
        )}

      </div>

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInFromBottom { 
          from { transform: translateY(20px); opacity: 0; } 
          to { transform: translateY(0); opacity: 1; } 
        }
        
        .animate-in { animation-duration: 0.5s; animation-fill-mode: forwards; }
        .fade-in { animation-name: fadeIn; }
        .slide-in-from-bottom-4 { animation-name: slideInFromBottom; }
        
        /* Custom Radial Gradient for Desktop BG */
        .bg-radial-gradient {
          background: radial-gradient(circle at center, var(--tw-gradient-from), var(--tw-gradient-to));
        }
      `}</style>
    </div>
  );
}
