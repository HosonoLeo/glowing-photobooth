<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Licowa Photobooth - Studio Privé</title>
    
    <!-- Scripts & Styles CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #171717;
            margin: 0;
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInFromBottom { 
          from { transform: translateY(20px); opacity: 0; } 
          to { transform: translateY(0); opacity: 1; } 
        }
        
        .animate-in { animation-duration: 0.5s; animation-fill-mode: forwards; }
        .fade-in { animation-name: fadeIn; }
        .slide-in-from-bottom-4 { animation-name: slideInFromBottom; }
        
        .bg-radial-gradient {
          background: radial-gradient(circle at center, #262626, #0a0a0a);
        }

        @keyframes ping-once {
          0% { transform: scale(0.8); opacity: 0; }
          50% { opacity: 1; }
          100% { transform: scale(1.2); opacity: 0; }
        }
        .animate-ping-once {
          animation: ping-once 1s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration simplifiée pour Lucide dans cet environnement
        const Icon = ({ name, size = 20, strokeWidth = 2, className = "", fill = "none" }) => {
            const [svg, setSvg] = useState("");
            useEffect(() => {
                // Utilisation de l'API Lucide globale
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        // On crée un petit hack pour transformer le noeud lucide en SVG
                        const attrs = {
                            ...iconNode[1],
                            width: size,
                            height: size,
                            "stroke-width": strokeWidth,
                            class: className,
                            fill: fill,
                            stroke: "currentColor"
                        };
                        const attrString = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(" ");
                        const content = iconNode[2].map(child => `<${child[0]} ${Object.entries(child[1]).map(([k, v]) => `${k}="${v}"`).join(" ")} />`).join("");
                        setSvg(`<svg ${attrString}>${content}</svg>`);
                    }
                }
            }, [name, size, className, fill]);

            return <span dangerouslySetInnerHTML={{ __html: svg }} />;
        };

        const ASSETS = {
            marketing: "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?auto=format&fit=crop&q=80&w=1000",
            stickers: [
                "https://cdn-icons-png.flaticon.com/512/1023/1023656.png",
                "https://cdn-icons-png.flaticon.com/512/3214/3214750.png",
                "https://cdn-icons-png.flaticon.com/512/1023/1023661.png",
                "https://cdn-icons-png.flaticon.com/512/1023/1023666.png",
                "https://cdn-icons-png.flaticon.com/512/744/744922.png",
            ]
        };

        const LAYOUT_CONFIGS = {
            bandelette: { name: "Bandelette Rétro", photoCount: 3, canvasWidth: 400, canvasHeight: 1200, description: "Format strip classique 5x15cm" },
            polaroid: { name: "Format Polaroid", photoCount: 1, canvasWidth: 800, canvasHeight: 1000, description: "Carré vintage avec bordure large" },
            planche: { name: "Planche Événement", photoCount: 4, canvasWidth: 800, canvasHeight: 1200, description: "Grille 2x2 pour un maximum de souvenirs" }
        };

        const apiKey = ""; // Insérez votre clé ici si nécessaire
        const GEN_MODEL = "gemini-2.5-flash-preview-09-2025";

        async function callGemini(prompt, base64Image = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEN_MODEL}:generateContent?key=${apiKey}`;
            const contents = [{ parts: [{ text: prompt }] }];
            if (base64Image) {
                const base64Data = base64Image.split(',')[1] || base64Image;
                contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }
            const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents }) });
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur";
        }

        function App() {
            const [currentStep, setCurrentStep] = useState('landing');
            const [layout, setLayout] = useState('bandelette'); 
            const [photos, setPhotos] = useState([]);
            const [capturingIndex, setCapturingIndex] = useState(null);
            const [isSequenceRunning, setIsSequenceRunning] = useState(false);
            const [countdown, setCountdown] = useState(null);
            const [flash, setFlash] = useState(false);
            const [customText, setCustomText] = useState("SOUVENIR PHOTO");
            const [isAiLoading, setIsAiLoading] = useState(false);

            const videoRef = useRef(null);
            const fabricCanvas = useRef(null);

            const navigateTo = (step) => setCurrentStep(step);

            const startWebcam = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) { console.error(err); }
            };

            const stopWebcam = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                }
            };

            const handleAiInspiration = async () => {
                if (!photos[0]) return;
                setIsAiLoading(true);
                try {
                    const aiText = await callGemini("Propose une légende très courte (max 20 caractères), chic pour un photobooth. Réponds UNIQUEMENT avec la légende.", photos[0]);
                    setCustomText(aiText.trim().toUpperCase());
                } catch (e) {} finally { setIsAiLoading(false); }
            };

            const startFullSequence = async () => {
                setIsSequenceRunning(true);
                const count = LAYOUT_CONFIGS[layout].photoCount;
                const newPhotos = Array(count).fill(null);
                setPhotos(newPhotos);
                for (let i = 0; i < count; i++) {
                    await performCapture(i);
                    if (i < count - 1) await new Promise(r => setTimeout(r, 1500));
                }
                setIsSequenceRunning(false);
                navigateTo('review');
            };

            const performCapture = (index) => {
                return new Promise((resolve) => {
                    setCapturingIndex(index);
                    let count = 3;
                    setCountdown(count);
                    const timer = setInterval(() => {
                        count--;
                        if (count > 0) { setCountdown(count); } 
                        else {
                            clearInterval(timer);
                            setCountdown(0);
                            setFlash(true);
                            setTimeout(() => setFlash(false), 150);
                            const video = videoRef.current;
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                            ctx.drawImage(video, 0, 0);
                            const dataUrl = canvas.toDataURL('image/jpeg');
                            setPhotos(prev => { const n = [...prev]; n[index] = dataUrl; return n; });
                            setTimeout(() => { setCountdown(null); setCapturingIndex(null); resolve(); }, 800);
                        }
                    }, 1000);
                });
            };

            useEffect(() => {
                if (currentStep === 'edit' && !fabricCanvas.current) {
                    const config = LAYOUT_CONFIGS[layout];
                    const canvas = new fabric.Canvas('photobooth-canvas', { width: config.canvasWidth, height: config.canvasHeight, backgroundColor: '#ffffff' });
                    fabricCanvas.current = canvas;
                    renderFinalCanvas();
                }
            }, [currentStep]);

            const renderFinalCanvas = async () => {
                const canvas = fabricCanvas.current;
                if (!canvas) return;
                canvas.clear();
                const config = LAYOUT_CONFIGS[layout];
                for (let i = 0; i < config.photoCount; i++) {
                    if (!photos[i]) continue;
                    await new Promise(r => {
                        fabric.Image.fromURL(photos[i], (img) => {
                            let x, y, w;
                            if (layout === 'bandelette') { w = config.canvasWidth - 40; x = 20; y = 20 + i * (w * 0.75 + 20); }
                            else if (layout === 'polaroid') { w = config.canvasWidth - 80; x = 40; y = 40; }
                            else if (layout === 'planche') { w = (config.canvasWidth / 2) - 30; x = i % 2 === 0 ? 20 : config.canvasWidth / 2 + 10; y = i < 2 ? 20 : config.canvasHeight / 2 - 100; }
                            img.set({ left: x, top: y, selectable: false });
                            img.scaleToWidth(w);
                            canvas.add(img);
                            r();
                        });
                    });
                }
                const text = new fabric.Text(customText.toUpperCase(), { left: config.canvasWidth / 2, top: config.canvasHeight - 60, fontSize: 24, fontFamily: 'Helvetica', fontWeight: 'bold', originX: 'center', fill: '#333', selectable: false });
                canvas.add(text);
            };

            const addSticker = (url) => {
                fabric.Image.fromURL(url, (img) => {
                    img.scaleToWidth(120);
                    img.set({ left: 50, top: 50, cornerColor: '#000' });
                    fabricCanvas.current.add(img).setActiveObject(img);
                }, { crossOrigin: 'anonymous' });
            };

            return (
                <div className="relative w-full h-screen bg-neutral-900 flex items-center justify-center overflow-hidden font-sans">
                    <div className="absolute inset-0 z-0 bg-radial-gradient opacity-50" />
                    
                    <div className="relative z-10 w-full h-full sm:max-w-md sm:h-[90vh] sm:rounded-[3rem] sm:border-[12px] sm:border-neutral-800 bg-neutral-950 overflow-hidden shadow-2xl">
                        
                        {/* Header */}
                        <div className="absolute top-0 left-0 right-0 h-20 flex items-center justify-between px-6 z-[60]">
                            {currentStep !== 'landing' && !isSequenceRunning && (
                                <button onClick={() => navigateTo('landing')} className="p-3 bg-white text-black rounded-full shadow-xl active:scale-90 transition"><Icon name="ArrowLeft" /></button>
                            )}
                            <div className="flex-1 flex justify-center"><span className="text-white font-black tracking-[0.3em] text-[10px] uppercase opacity-80">Licowa Style</span></div>
                        </div>

                        {flash && <div className="absolute inset-0 bg-white z-[100] animate-pulse" />}

                        {currentStep === 'landing' && (
                            <div className="flex flex-col items-center justify-between h-full py-16 px-8 text-center animate-in fade-in">
                                <div className="space-y-4 pt-10">
                                    <h1 className="text-4xl sm:text-5xl font-black italic uppercase leading-none text-white">Studio<br/><span className="text-neutral-500">Privé</span></h1>
                                    <p className="text-neutral-400 tracking-widest text-[10px] font-bold uppercase">L'art du portrait instantané</p>
                                </div>
                                <div className="relative w-full max-w-[260px] aspect-[4/5] shadow-2xl"><img src={ASSETS.marketing} className="w-full h-full object-cover rounded-sm grayscale-[0.2]" /><div className="absolute inset-0 border border-white/20 m-3 pointer-events-none" /></div>
                                <button onClick={() => navigateTo('layout')} className="w-full py-6 bg-white text-black rounded-full font-black text-xs tracking-[0.3em] uppercase active:scale-95 transition flex items-center justify-center gap-2">Commencer <Icon name="ChevronRight" size={16}/></button>
                            </div>
                        )}

                        {currentStep === 'layout' && (
                            <div className="flex flex-col items-center justify-center h-full p-8 pt-20 animate-in slide-in-from-bottom-4">
                                <h2 className="text-[10px] font-black mb-10 uppercase tracking-[0.4em] text-neutral-500">Choix du format</h2>
                                <div className="grid grid-cols-1 gap-4 w-full">
                                    {Object.entries(LAYOUT_CONFIGS).map(([key, cfg]) => (
                                        <button key={key} onClick={() => { setLayout(key); navigateTo('capture'); startWebcam(); }} className="flex items-center gap-6 p-5 bg-neutral-900/40 hover:bg-neutral-800 rounded-2xl border border-white/5 transition text-left">
                                            <div className="w-10 h-14 bg-white/5 flex items-center justify-center">
                                                <Icon name="ImageIcon" size={24} className="opacity-40" />
                                            </div>
                                            <div>
                                                <span className="block font-black text-xs uppercase text-white">{cfg.name}</span>
                                                <span className="text-neutral-600 text-[9px] font-bold uppercase">{cfg.description}</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {currentStep === 'capture' && (
                            <div className="relative h-full w-full bg-black">
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover scale-x-[-1]" />
                                {countdown !== null && <div className="absolute inset-0 flex items-center justify-center z-50"><span className="text-[15rem] font-black text-white italic drop-shadow-2xl">{countdown === 0 ? "!" : countdown}</span></div>}
                                <div className="absolute inset-x-0 bottom-0 p-8 flex flex-col items-center gap-6 bg-gradient-to-t from-black to-transparent">
                                    <div className="flex gap-2">{photos.map((p, i) => <div key={i} className={`w-8 h-12 border-2 ${capturingIndex === i ? 'border-white' : 'border-white/10 opacity-30'}`}>{p && <img src={p} className="w-full h-full object-cover" />}</div>)}</div>
                                    {!isSequenceRunning && <button onClick={startFullSequence} className="w-20 h-20 rounded-full bg-white flex items-center justify-center active:scale-90 transition"><Icon name="Play" size={32} fill="black" className="text-black ml-1"/></button>}
                                </div>
                            </div>
                        )}

                        {currentStep === 'review' && (
                            <div className="flex flex-col h-full bg-neutral-950 pt-20">
                                <div className="flex-1 flex flex-col items-center justify-center p-6">
                                    <div className={`bg-white p-4 shadow-2xl flex flex-col items-center ${layout === 'bandelette' ? 'w-40 aspect-[1/3.2]' : 'w-64 aspect-[4/5.2]'}`}>
                                        <div className={`w-full grid gap-2 ${layout === 'planche' ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                            {photos.map((p, i) => <div key={i} className="bg-neutral-100 aspect-[4/3] overflow-hidden"><img src={p} className="w-full h-full object-cover" /></div>)}
                                        </div>
                                        <div className="mt-auto py-4 text-black/20 font-black text-[8px] tracking-[0.4em] uppercase">{customText}</div>
                                    </div>
                                </div>
                                <div className="p-8"><button onClick={() => { stopWebcam(); navigateTo('edit'); }} className="w-full py-5 bg-white text-black font-black text-[10px] tracking-[0.3em] uppercase rounded-full">Personnaliser</button></div>
                            </div>
                        )}

                        {currentStep === 'edit' && (
                            <div className="flex flex-col h-full bg-neutral-950 pt-20">
                                <div className="flex-1 flex items-center justify-center p-4">
                                    <div className="transform scale-[0.35] sm:scale-[0.55] origin-center"><canvas id="photobooth-canvas" /></div>
                                </div>
                                <div className="bg-neutral-900 p-6 flex flex-col gap-4 rounded-t-[2rem]">
                                    <div className="flex justify-between items-center"><label className="text-[8px] font-black text-neutral-600 uppercase">Signature</label><button onClick={handleAiInspiration} className="text-[8px] font-black text-blue-400 uppercase tracking-widest">{isAiLoading ? "Chargement..." : "✨ Inspiration IA"}</button></div>
                                    <input type="text" value={customText} onChange={(e) => {setCustomText(e.target.value); renderFinalCanvas();}} className="w-full bg-black border border-white/10 p-3 rounded-xl text-white text-[10px] uppercase outline-none" />
                                    <div className="flex gap-2 overflow-x-auto no-scrollbar">{ASSETS.stickers.map((s, idx) => <button key={idx} onClick={() => addSticker(s)} className="flex-shrink-0 w-11 h-11 bg-black p-2.5 rounded-xl"><img src={s} className="w-full h-full object-contain" /></button>)}</div>
                                    <button onClick={() => navigateTo('final')} className="w-full py-4 bg-white text-black font-black text-[10px] rounded-full uppercase">Terminer</button>
                                </div>
                            </div>
                        )}

                        {currentStep === 'final' && (
                            <div className="flex flex-col items-center justify-center h-full p-10 text-center bg-white">
                                <div className="w-16 h-16 bg-black text-white rounded-full flex items-center justify-center mb-8"><Icon name="Check" size={28} /></div>
                                <h2 className="text-4xl font-black mb-3 italic uppercase leading-none text-black">C'est terminé.</h2>
                                <div className="w-full space-y-3">
                                    <button onClick={() => { const link = document.createElement('a'); link.download = 'capture.png'; link.href = fabricCanvas.current.toDataURL(); link.click(); }} className="w-full py-5 bg-black text-white font-black text-[10px] rounded-full tracking-widest uppercase flex items-center justify-center gap-2"><Icon name="Download" size={18} /> Télécharger</button>
                                    <button onClick={() => navigateTo('landing')} className="mt-8 text-neutral-400 font-black uppercase text-[8px] tracking-[0.5em] flex items-center justify-center gap-2"><Icon name="RotateCcw" size={12} /> Nouvelle Séance</button>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
